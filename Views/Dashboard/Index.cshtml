@{
    ViewData["Title"] = "Dashboard";
}

<!-- Stats Cards Row -->
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="stat-card primary">
            <div class="stat-header">
                <div>
                    <div class="stat-value" id="totalEmployees">0</div>
                    <div class="stat-label">Total Employees</div>
                </div>
                <div class="stat-icon primary">
                    <i class="bi bi-people-fill"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="stat-card success">
            <div class="stat-header">
                <div>
                    <div class="stat-value" id="activeShifts">0</div>
                    <div class="stat-label">Active Shifts</div>
                </div>
                <div class="stat-icon success">
                    <i class="bi bi-clock-fill"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="stat-card info">
            <div class="stat-header">
                <div>
                    <div class="stat-value" id="todayReports">0</div>
                    <div class="stat-label">Today's Reports</div>
                </div>
                <div class="stat-icon info">
                    <i class="bi bi-file-text-fill"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="stat-card warning">
            <div class="stat-header">
                <div>
                    <div class="stat-value" id="pendingApprovals">0</div>
                    <div class="stat-label">Pending Approvals</div>
                </div>
                <div class="stat-icon warning">
                    <i class="bi bi-exclamation-circle-fill"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Second Row Stats -->
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="stat-card info">
            <div class="stat-header">
                <div>
                    <div class="stat-value" id="totalLocations">0</div>
                    <div class="stat-label">Locations</div>
                </div>
                <div class="stat-icon info">
                    <i class="bi bi-geo-alt-fill"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="stat-card success">
            <div class="stat-header">
                <div>
                    <div class="stat-value" id="totalHoursToday">0</div>
                    <div class="stat-label">Hours Today</div>
                </div>
                <div class="stat-icon success">
                    <i class="bi bi-calendar-check-fill"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="stat-card primary">
            <div class="stat-header">
                <div>
                    <div class="stat-value" id="scheduledShifts">0</div>
                    <div class="stat-label">Scheduled Shifts</div>
                </div>
                <div class="stat-icon primary">
                    <i class="bi bi-calendar-week-fill"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="stat-card danger">
            <div class="stat-header">
                <div>
                    <div class="stat-value" id="missedPunches">0</div>
                    <div class="stat-label">Missed Punches</div>
                </div>
                <div class="stat-icon danger">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Active Shifts -->
    <div class="col-lg-6">
        <div class="custom-table">
            <div style="padding: 20px; border-bottom: 1px solid #f1f3f5;">
                <h5 class="mb-0" style="color: #344767; font-weight: 700;">
                    <i class="bi bi-clock-history me-2"></i>
                    Active Shifts
                </h5>
            </div>
            <div style="max-height: 400px; overflow-y: auto;" id="activeShiftsContainer">
                <div style="padding: 40px; text-align: center; color: #7b809a;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 mb-0">Loading active shifts...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Reports -->
    <div class="col-lg-6">
        <div class="custom-table">
            <div style="padding: 20px; border-bottom: 1px solid #f1f3f5;">
                <h5 class="mb-0" style="color: #344767; font-weight: 700;">
                    <i class="bi bi-file-earmark-text me-2"></i>
                    Recent Reports
                </h5>
            </div>
            <div style="max-height: 400px; overflow-y: auto;" id="recentReportsContainer">
                <div style="padding: 40px; text-align: center; color: #7b809a;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 mb-0">Loading recent reports...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Pending Approvals -->
<div class="row g-4 mt-2" id="pendingApprovalsSection" style="display: none;">
    <div class="col-12">
        <div class="custom-table">
            <div style="padding: 20px; border-bottom: 1px solid #f1f3f5; display: flex; justify-content: space-between; align-items: center;">
                <h5 class="mb-0" style="color: #344767; font-weight: 700;">
                    <i class="bi bi-person-check me-2"></i>
                    Pending User Approvals
                </h5>
                <span class="badge bg-warning" id="pendingApprovalsBadge">0 pending</span>
            </div>
            <table class="table mb-0">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Position</th>
                        <th>Registered</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="pendingApprovalsBody">
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Load dashboard data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardStats();
            loadActiveShifts();
            loadRecentReports();
            loadPendingUsers();

            // Auto-refresh dashboard every 30 seconds
            setInterval(function() {
                loadDashboardStats();
                loadActiveShifts();
                loadRecentReports();
                loadPendingUsers();
            }, 30000);
        });

        // Load dashboard statistics
        function loadDashboardStats() {
            fetch('/api/mobile/dashboard/stats')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.stats) {
                        document.getElementById('totalEmployees').textContent = data.stats.totalEmployees || 0;
                        document.getElementById('activeShifts').textContent = data.stats.activeShifts || 0;
                        document.getElementById('todayReports').textContent = data.stats.completedReportsToday || 0;
                        document.getElementById('pendingApprovals').textContent = data.stats.pendingApprovals || 0;
                        document.getElementById('totalLocations').textContent = data.stats.totalLocations || 0;
                        document.getElementById('totalHoursToday').textContent = data.stats.totalHoursToday || 0;
                        document.getElementById('scheduledShifts').textContent = data.stats.scheduledShiftsToday || 0;
                        document.getElementById('missedPunches').textContent = data.stats.missedPunches || 0;
                    }
                })
                .catch(error => {
                    console.error('Error loading dashboard stats:', error);
                });
        }

        // Load active shifts
        function loadActiveShifts() {
            fetch('/api/mobile/clock/active')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('activeShiftsContainer');

                    if (data.success && data.shifts && data.shifts.length > 0) {
                        let html = '<table class="table mb-0">';
                        html += '<thead><tr><th>Employee</th><th>Location</th><th>Clock In</th><th>Duration</th></tr></thead>';
                        html += '<tbody>';

                        data.shifts.forEach(shift => {
                            const clockInTime = new Date(shift.clockInTime);
                            const duration = calculateDuration(clockInTime);

                            html += '<tr>';
                            html += '<td><div style="font-weight: 600; color: #344767;">' + shift.userName + '</div></td>';
                            html += '<td><span class="badge bg-primary">' + shift.locationName + '</span></td>';
                            html += '<td><small class="text-muted">' + formatTime(clockInTime) + '</small></td>';
                            html += '<td><span class="badge bg-success">' + duration + '</span></td>';
                            html += '</tr>';
                        });

                        html += '</tbody></table>';
                        container.innerHTML = html;
                    } else {
                        container.innerHTML = '<div style="padding: 40px; text-align: center; color: #7b809a;">' +
                            '<i class="bi bi-clock" style="font-size: 48px; opacity: 0.3;"></i>' +
                            '<p class="mt-3 mb-0">No active shifts at the moment</p>' +
                            '</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading active shifts:', error);
                    document.getElementById('activeShiftsContainer').innerHTML =
                        '<div style="padding: 40px; text-align: center; color: #dc3545;">' +
                        '<i class="bi bi-exclamation-triangle" style="font-size: 48px; opacity: 0.3;"></i>' +
                        '<p class="mt-3 mb-0">Error loading active shifts</p>' +
                        '</div>';
                });
        }

        // Load recent reports
        function loadRecentReports() {
            fetch('/api/mobile/reports/recent?count=5')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('recentReportsContainer');

                    if (data.success && data.reports && data.reports.length > 0) {
                        let html = '<table class="table mb-0">';
                        html += '<thead><tr><th>Tech</th><th>Location</th><th>Date</th><th>Status</th></tr></thead>';
                        html += '<tbody>';

                        data.reports.forEach(report => {
                            const serviceDate = new Date(report.serviceDate);

                            html += '<tr>';
                            html += '<td><div style="font-weight: 600; color: #344767;">' + report.techName + '</div></td>';
                            html += '<td><span class="badge bg-info">' + report.locationName + '</span></td>';
                            html += '<td><small class="text-muted">' + formatDate(serviceDate) + '</small></td>';
                            html += '<td><span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Completed</span></td>';
                            html += '</tr>';
                        });

                        html += '</tbody></table>';
                        container.innerHTML = html;
                    } else {
                        container.innerHTML = '<div style="padding: 40px; text-align: center; color: #7b809a;">' +
                            '<i class="bi bi-file-earmark" style="font-size: 48px; opacity: 0.3;"></i>' +
                            '<p class="mt-3 mb-0">No recent reports</p>' +
                            '</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading recent reports:', error);
                    document.getElementById('recentReportsContainer').innerHTML =
                        '<div style="padding: 40px; text-align: center; color: #dc3545;">' +
                        '<i class="bi bi-exclamation-triangle" style="font-size: 48px; opacity: 0.3;"></i>' +
                        '<p class="mt-3 mb-0">Error loading recent reports</p>' +
                        '</div>';
                });
        }

        // Load pending users
        function loadPendingUsers() {
            fetch('/api/mobile/users/pending')
                .then(response => response.json())
                .then(data => {
                    const section = document.getElementById('pendingApprovalsSection');
                    const body = document.getElementById('pendingApprovalsBody');
                    const badge = document.getElementById('pendingApprovalsBadge');

                    if (data.success && data.users && data.users.length > 0) {
                        badge.textContent = data.count + ' pending';

                        let html = '';
                        data.users.forEach(user => {
                            const createdAt = new Date(user.createdAt);

                            html += '<tr>';
                            html += '<td><div style="font-weight: 600; color: #344767;">' + user.firstName + ' ' + user.lastName + '</div></td>';
                            html += '<td><small class="text-muted">' + user.email + '</small></td>';
                            html += '<td><span class="badge bg-secondary">' + (user.position || 'Not Set') + '</span></td>';
                            html += '<td><small class="text-muted">' + formatDate(createdAt) + '</small></td>';
                            html += '<td><a href="/Users/Details/' + user.userId + '" class="btn btn-sm btn-primary"><i class="bi bi-eye me-1"></i>Review</a></td>';
                            html += '</tr>';
                        });

                        body.innerHTML = html;
                        section.style.display = 'block';
                    } else {
                        section.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error loading pending users:', error);
                    document.getElementById('pendingApprovalsSection').style.display = 'none';
                });
        }

        // Helper function to calculate duration
        function calculateDuration(startTime) {
            const now = new Date();
            const diff = now - startTime;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            return hours + ' h ' + minutes + ' m';
        }

        // Helper function to format time
        function formatTime(date) {
            let hours = date.getHours();
            const minutes = date.getMinutes();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12;
            const minutesStr = minutes < 10 ? '0' + minutes : minutes;
            return hours + ':' + minutesStr + ' ' + ampm;
        }

        // Helper function to format date
        function formatDate(date) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return months[date.getMonth()] + ' ' + date.getDate();
        }
    </script>
}
